# ğŸš€ React Fiber æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå®ƒå¾ˆé‡è¦ï¼Ÿ

> ä½œè€…ï¼šä½   
> æ›´æ–°æ—¶é—´ï¼š2025-04-29  
> æ ‡ç­¾ï¼šReactã€Fiberã€å¼‚æ­¥æ¸²æŸ“ã€è°ƒåº¦æœºåˆ¶ã€æºç è§£æ

---

## ğŸ“Œ ä¸ºä»€ä¹ˆè¦æ¨å‡º Fiberï¼Ÿ

React åœ¨ 16 ä¹‹å‰ï¼Œæ¯æ¬¡æ›´æ–° UI æ—¶ï¼Œéƒ½ä¼š**ä¸€æ¬¡æ€§ä»å¤´åˆ°å°¾é‡æ–°æ¸²æŸ“æ•´ä¸ªç»„ä»¶æ ‘**ï¼ˆå“ªæ€•åªæ˜¯å±€éƒ¨å˜æ›´ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ï¼š

- åŒæ­¥æ‰§è¡Œçš„ï¼›
- ä¸èƒ½è¢«æ‰“æ–­ï¼›
- å¦‚æœæ ‘å¤ªå¤§ï¼Œæˆ–è€…è®¾å¤‡æ€§èƒ½ä¸å¥½ï¼Œä¼šå¯¼è‡´ï¼š
  - é¡µé¢å¡é¡¿ï¼›
  - åŠ¨ç”»æ‰å¸§ï¼›
  - ç”¨æˆ·è¾“å…¥ä¸æµç•…ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šå½“ä½ åœ¨è¡¨å•è¾“å…¥æ¡†è¾“å…¥å†…å®¹æ—¶ï¼Œé¡µé¢æ­£åœ¨åŒæ—¶æ¸²æŸ“ä¸€æ£µå¤§ç»„ä»¶æ ‘ï¼Œç”±äºæ›´æ–°ä¸èƒ½ä¸­æ–­ï¼Œ**ç”¨æˆ·è¾“å…¥å¯èƒ½è¦ç­‰ UI æ¸²æŸ“å®Œå†å“åº”**ï¼Œä½“éªŒéå¸¸å·®ã€‚

> æ‰€ä»¥ React å›¢é˜Ÿå†³å®šé‡æ„åº•å±‚åè°ƒå™¨ï¼Œå¼•å…¥ Fiber æ¶æ„ï¼Œç›®æ ‡å°±æ˜¯è®© UI æ¸²æŸ“ **å˜å¾—æ›´æ™ºèƒ½ã€æ›´æµç•…**ã€‚

---

## ğŸ› ï¸ Fiber è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

| æ—§ç‰ˆ Reactï¼ˆ15 åŠä»¥å‰ï¼‰ | React Fiber          |
| ----------------------- | -------------------- |
| åŒæ­¥æ‰§è¡Œï¼Œä¸èƒ½ä¸­æ–­      | æ¸²æŸ“è¿‡ç¨‹å¯ä¸­æ–­       |
| ä¸æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§        | æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦       |
| æ¸²æŸ“è¿‡ç¨‹ä¸­ä¸å¯æ’é˜Ÿ      | é«˜ä¼˜ä»»åŠ¡å¯ä»¥æ’é˜Ÿ     |
| æ„å»ºæ–¹å¼æ˜¯é€’å½’          | æ„å»ºæ–¹å¼æ˜¯é“¾è¡¨éå†   |
| å¯¹åŠ¨ç”»ã€äº¤äº’æ”¯æŒå·®      | å“åº”é€Ÿåº¦æ›´å¿«ã€æ›´å¹³æ»‘ |
| é”™è¯¯æ•è·ä¸å¤Ÿå®Œå–„        | åŠ å¼ºäº†é”™è¯¯è¾¹ç•Œæœºåˆ¶   |

---

## ğŸ¤” ä»€ä¹ˆæ˜¯ React Fiberï¼Ÿ

**Fiber** æ˜¯ React ç”¨æ¥æè¿°ç»„ä»¶çš„å†…éƒ¨æ•°æ®ç»“æ„ã€‚æ¯ä¸ªç»„ä»¶éƒ½ä¼šå¯¹åº”ä¸€ä¸ª â€œFiber èŠ‚ç‚¹â€ã€‚

å®ƒæ˜¯å¯¹åŸæ¥ Virtual DOM çš„é‡å†™ç‰ˆæœ¬ â€”â€” **æ”¯æŒæ›´çµæ´»ã€å¢é‡å¼çš„æ¸²æŸ“è¿‡ç¨‹**ã€‚

### ğŸ¯ Fiber åšäº†ä¸‰ä»¶å…³é”®çš„äº‹ï¼š

1. æŠŠæ•´æ£µç»„ä»¶æ ‘çš„æ›´æ–° **æ‹†æˆä¸€ä¸ªä¸ªå°ä»»åŠ¡**ï¼›
2. è®©è¿™äº›ä»»åŠ¡å¯ä»¥ **ä¸­æ–­ã€æ¢å¤ã€å–æ¶ˆ**ï¼›
3. æ ¹æ®ä¸åŒä»»åŠ¡çš„ **ä¼˜å…ˆçº§**ï¼Œå®‰æ’å®ƒä»¬å…ˆåæ‰§è¡Œã€‚

è¿™å°±åƒæµè§ˆå™¨ç”»å›¾ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§æŠŠå›¾å…¨ç”»å‡ºæ¥ï¼Œè€Œæ˜¯**ä¸€ç¬”ä¸€ç¬”æ…¢æ…¢ç”»**ï¼Œä¿è¯æœ€é‡è¦çš„éƒ¨åˆ†å…ˆæ˜¾ç¤ºå‡ºæ¥ï¼Œç”¨æˆ·ä½“éªŒæ›´é¡ºæ»‘ã€‚

---

## ğŸ§© Fiber æ ¸å¿ƒæºç ç®€æï¼ˆç®€åŒ–ç‰ˆï¼‰

### 1. æ¯ä¸ª Fiber èŠ‚ç‚¹é•¿è¿™æ ·ï¼ˆç®€åŒ–ï¼‰ï¼š

```ts
interface FiberNode {
  type: any; // ç»„ä»¶ç±»å‹
  key: string | null;
  child: FiberNode | null;
  sibling: FiberNode | null;
  return: FiberNode | null; // çˆ¶èŠ‚ç‚¹
  stateNode: any; // å¯¹åº”çš„ DOM æˆ– class ç»„ä»¶å®ä¾‹
  alternate: FiberNode | null; // åŒç¼“å­˜æœºåˆ¶
  flags: Flags; // æ ‡è®°å‰¯ä½œç”¨
  ...
}
```

- æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª **å•å‘é“¾è¡¨ç»“æ„**ï¼›
- é¿å…äº†é€’å½’å¯¼è‡´çš„è°ƒç”¨æ ˆçˆ†ç‚¸ï¼›
- å¯ä»¥ **æ‰‹åŠ¨éå†ã€æš‚åœå’Œæ¢å¤**ã€‚

---

### 2. åŒç¼“å­˜æœºåˆ¶ï¼š`current` å’Œ `workInProgress`

- `current`ï¼šå½“å‰å·²ç»å±•ç¤ºåœ¨é¡µé¢ä¸Šçš„ Fiber æ ‘ï¼›
- `workInProgress`ï¼šè¿™æ¬¡æ›´æ–°è¦ç”Ÿæˆçš„æ–° Fiber æ ‘ï¼›
- æ¸²æŸ“æ—¶æˆ‘ä»¬æ„å»º `workInProgress`ï¼ŒæˆåŠŸåå†åˆ‡æ¢ `current`ï¼›

ğŸ‘‰ è¿™æ ·ä¸€æ¥ï¼Œæ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹å°±åƒæ˜¯â€œåšè‰ç¨¿â€ï¼Œæ¸²æŸ“æˆåŠŸäº†æ‰â€œä¸Šå°è¡¨æ¼”â€ã€‚

---

### 3. æ¸²æŸ“è¿‡ç¨‹åˆ†ä¸ºä¸¤é˜¶æ®µï¼š

```txt
[æ›´æ–°è§¦å‘]
  â†“
Render é˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰
  â†“
Commit é˜¶æ®µï¼ˆä¸å¯ä¸­æ–­ï¼‰
```

- **Render é˜¶æ®µ**ï¼šæ„å»º Fiber æ ‘ï¼Œä¸æ¶‰åŠ DOMï¼›
- **Commit é˜¶æ®µ**ï¼šæ ¹æ®å˜åŒ–æ“ä½œ DOMï¼Œæ‰§è¡Œç”Ÿå‘½å‘¨æœŸç­‰ï¼›

**åªæœ‰ Commit æ˜¯çœŸæ­£åŠ¨äº† DOMï¼Œå‰é¢éƒ½æ˜¯å‡†å¤‡å·¥ä½œã€‚**

---

## ğŸ§  ä¸ªäººç†è§£ï¼šFiber åƒæ˜¯â€œå¾®æ“ä½œç³»ç»Ÿâ€

React Fiber æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œå®ƒå°±åƒä¸€ä¸ªç®€æ˜“çš„â€œå‰ç«¯è°ƒåº¦æ“ä½œç³»ç»Ÿâ€ï¼š

- **è°ƒåº¦å™¨**ï¼šå†³å®šå“ªä¸ªä»»åŠ¡è¯¥å…ˆæ‰§è¡Œï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ä¼˜å…ˆäºä½ä¼˜å…ˆçº§åˆ·æ–°ï¼‰ï¼›
- **æ‰§è¡Œå•å…ƒ**ï¼šæŠŠæ¯ä¸ªç»„ä»¶æ‹†æˆå°ä»»åŠ¡é€ä¸ªæ‰§è¡Œï¼›
- **ä¸­æ–­/æ¢å¤æœºåˆ¶**ï¼šç”¨ `requestIdleCallback` / `MessageChannel` æ§åˆ¶ä»»åŠ¡èŠ‚å¥ï¼›
- **é”™è¯¯è¾¹ç•Œ**ï¼šåƒ try/catch ä¸€æ ·åšå®¹é”™å¤„ç†ã€‚

ä½ å¯ä»¥æŠŠ Fiber ç†è§£æˆï¼š**æŠŠæ¸²æŸ“è¿‡ç¨‹åšæˆäº†ä¸€ç§â€œåç¨‹â€ï¼Œå¯ä»¥æš‚åœã€æ¢å¤ã€ç®¡ç†ä¼˜å…ˆçº§çš„åç¨‹ã€‚**

---

## âœ… æ€»ç»“

React Fiber æ˜¯ React å†…éƒ¨æ¶æ„çš„ä¸€æ¬¡é‡å¤§é‡æ„ï¼Œå®ƒå¸¦æ¥äº†ï¼š

- ä¸­æ–­å¼æ¸²æŸ“ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼›
- ä»»åŠ¡è°ƒåº¦ä¸ä¼˜å…ˆçº§æ§åˆ¶ï¼›
- æ›´å¼ºçš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼›
- æ”¯æŒå¼‚æ­¥æ¸²æŸ“ã€å¹¶å‘æ¨¡å¼çš„æŠ€æœ¯åŸºç¡€ã€‚

### ä¸€å¥è¯æ€»ç»“ï¼š

> React Fiber æŠŠåŸæ¥ä¸€æ¬¡æ€§åŒæ­¥æ‰§è¡Œçš„æ›´æ–°æµç¨‹ï¼Œå˜æˆäº†ä¸€ä¸ªå¯ä»¥æ‹†åˆ†ã€æ‰“æ–­ã€è°ƒåº¦çš„å¼‚æ­¥æµç¨‹ â€”â€” è¿™æ˜¯ç°ä»£å‰ç«¯ UI å¼•æ“çš„æ ¸å¿ƒèƒ½åŠ›ä¹‹ä¸€ã€‚

---

## ğŸ“š å»¶ä¼¸é˜…è¯»æ¨è

- [React å®˜æ–¹æ–‡æ¡£ï¼šReconciliation](https://react.dev/learn/render-and-commit)
- [Lin Clark çš„ Fiber æ¶æ„å›¾è§£](https://engineering.fb.com/2017/09/26/web/react-v16/)
- React æºç æ ¸å¿ƒåŒ…ï¼š`react-reconciler`
