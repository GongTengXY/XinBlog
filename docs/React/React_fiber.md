# 🚀 React Fiber 是什么？为什么它很重要？

> 作者：你  
> 更新时间：2025-04-29  
> 标签：React、Fiber、异步渲染、调度机制、源码解析

---

## 📌 为什么要推出 Fiber？

React 在 16 之前，每次更新 UI 时，都会**一次性从头到尾重新渲染整个组件树**（哪怕只是局部变更）。这个过程是：

- 同步执行的；
- 不能被打断；
- 如果树太大，或者设备性能不好，会导致：
  - 页面卡顿；
  - 动画掉帧；
  - 用户输入不流畅。

举个例子：当你在表单输入框输入内容时，页面正在同时渲染一棵大组件树，由于更新不能中断，**用户输入可能要等 UI 渲染完再响应**，体验非常差。

> 所以 React 团队决定重构底层协调器，引入 Fiber 架构，目标就是让 UI 渲染 **变得更智能、更流畅**。

---

## 🛠️ Fiber 解决了什么问题？

| 旧版 React（15 及以前） | React Fiber          |
| ----------------------- | -------------------- |
| 同步执行，不能中断      | 渲染过程可中断       |
| 不支持任务优先级        | 支持优先级调度       |
| 渲染过程中不可插队      | 高优任务可以插队     |
| 构建方式是递归          | 构建方式是链表遍历   |
| 对动画、交互支持差      | 响应速度更快、更平滑 |
| 错误捕获不够完善        | 加强了错误边界机制   |

---

## 🤔 什么是 React Fiber？

**Fiber** 是 React 用来描述组件的内部数据结构。每个组件都会对应一个 “Fiber 节点”。

它是对原来 Virtual DOM 的重写版本 —— **支持更灵活、增量式的渲染过程**。

### 🎯 Fiber 做了三件关键的事：

1. 把整棵组件树的更新 **拆成一个个小任务**；
2. 让这些任务可以 **中断、恢复、取消**；
3. 根据不同任务的 **优先级**，安排它们先后执行。

这就像浏览器画图，不是一次性把图全画出来，而是**一笔一笔慢慢画**，保证最重要的部分先显示出来，用户体验更顺滑。

---

## 🧩 Fiber 核心源码简析（简化版）

### 1. 每个 Fiber 节点长这样（简化）：

```ts
interface FiberNode {
  type: any; // 组件类型
  key: string | null;
  child: FiberNode | null;
  sibling: FiberNode | null;
  return: FiberNode | null; // 父节点
  stateNode: any; // 对应的 DOM 或 class 组件实例
  alternate: FiberNode | null; // 双缓存机制
  flags: Flags; // 标记副作用
  ...
}
```

- 每个节点是一个 **单向链表结构**；
- 避免了递归导致的调用栈爆炸；
- 可以 **手动遍历、暂停和恢复**。

---

### 2. 双缓存机制：`current` 和 `workInProgress`

- `current`：当前已经展示在页面上的 Fiber 树；
- `workInProgress`：这次更新要生成的新 Fiber 树；
- 渲染时我们构建 `workInProgress`，成功后再切换 `current`；

👉 这样一来，整个渲染过程就像是“做草稿”，渲染成功了才“上台表演”。

---

### 3. 渲染过程分为两阶段：

```txt
[更新触发]
  ↓
Render 阶段（可中断）
  ↓
Commit 阶段（不可中断）
```

- **Render 阶段**：构建 Fiber 树，不涉及 DOM；
- **Commit 阶段**：根据变化操作 DOM，执行生命周期等；

**只有 Commit 是真正动了 DOM，前面都是准备工作。**

---

## 🧠 个人理解：Fiber 像是“微操作系统”

React Fiber 本质上是一个任务调度系统，它就像一个简易的“前端调度操作系统”：

- **调度器**：决定哪个任务该先执行（如用户输入优先于低优先级刷新）；
- **执行单元**：把每个组件拆成小任务逐个执行；
- **中断/恢复机制**：用 `requestIdleCallback` / `MessageChannel` 控制任务节奏；
- **错误边界**：像 try/catch 一样做容错处理。

你可以把 Fiber 理解成：**把渲染过程做成了一种“协程”，可以暂停、恢复、管理优先级的协程。**

---

## ✅ 总结

React Fiber 是 React 内部架构的一次重大重构，它带来了：

- 中断式渲染，提升用户体验；
- 任务调度与优先级控制；
- 更强的错误处理能力；
- 支持异步渲染、并发模式的技术基础。

### 一句话总结：

> React Fiber 把原来一次性同步执行的更新流程，变成了一个可以拆分、打断、调度的异步流程 —— 这是现代前端 UI 引擎的核心能力之一。

---

## 📚 延伸阅读推荐

- [React 官方文档：Reconciliation](https://react.dev/learn/render-and-commit)
- [Lin Clark 的 Fiber 架构图解](https://engineering.fb.com/2017/09/26/web/react-v16/)
- React 源码核心包：`react-reconciler`
